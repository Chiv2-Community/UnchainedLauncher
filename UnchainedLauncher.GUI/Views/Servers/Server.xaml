<UserControl x:Class="UnchainedLauncher.GUI.Views.Servers.Server"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:UnchainedLauncher.GUI.Converters"
             xmlns:behaviors="clr-namespace:UnchainedLauncher.GUI.Behaviors"
             xmlns:instances="clr-namespace:UnchainedLauncher.GUI.Views.Servers.DesignInstances"
             d:DataContext="{d:DesignInstance instances:ServerDesignVM}"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">

    <Border Style="{StaticResource Card}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0"
                       FontSize="18"
                       FontWeight="SemiBold"
                       Text="{Binding ServerName}" />

            <!-- Uptime timeline (top, no label) -->
            <Border Grid.Row="1"
                    Margin="0,8,0,0"
                    Height="12"
                    CornerRadius="4"
                    Background="{DynamicResource Brush.Background}"
                    BorderBrush="{DynamicResource Brush.Border}"
                    BorderThickness="1"
                    Padding="1">
                <ItemsControl ItemsSource="{Binding DisplayUpDownHistory}"
                              AlternationCount="100000">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Rows="1" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Rectangle>
                                <Rectangle.Style>
                                    <Style TargetType="Rectangle">
                                        <!-- Null = unrecorded (gray), Up = blue, Starting = yellow, Down = red -->
                                        <Setter Property="Fill" Value="#FF6C757D" />
                                        <Setter Property="Opacity" Value="0.85" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding}" Value="Up">
                                                <Setter Property="Fill" Value="{DynamicResource Brush.Primary}" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding}" Value="Starting">
                                                <Setter Property="Fill" Value="{DynamicResource Brush.Warning}" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding}" Value="Down">
                                                <Setter Property="Fill" Value="{DynamicResource Brush.Danger}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Rectangle.Style>
                                <Rectangle.ToolTip>
                                    <MultiBinding Converter="{x:Static converters:UptimeSegmentTooltipConverter.Instance}"
                                                  ConverterParameter="10">
                                        <Binding />
                                        <Binding Path="(ItemsControl.AlternationIndex)" RelativeSource="{RelativeSource AncestorType=ContentPresenter}" />
                                        <Binding Path="Items.Count" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                    </MultiBinding>
                                </Rectangle.ToolTip>
                            </Rectangle>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Border>

            <Grid Grid.Row="2" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="24" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Active server info -->
                <Grid Grid.Column="0">
                    <Grid.ColumnDefinitions>
                        <!-- 5 columns: label, data, gap, label, data -->
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="24" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Row 0 -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Players:" VerticalAlignment="Center" />
                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="10,0,0,0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock FontWeight="SemiBold" Text="{Binding PlayerCount, StringFormat={}{0:N0}}" />
                        <TextBlock Text="/" />
                        <TextBlock FontWeight="SemiBold" Text="{Binding MaxPlayers, StringFormat={}{0:N0}}" />
                    </StackPanel>

                    <!-- Row 1 -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Map:" Margin="0,4,0,0" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="1" Grid.Column="1" Margin="10,4,0,0" FontWeight="SemiBold" Text="{Binding CurrentMap}" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="1" Grid.Column="3" Text="Game Type:" Margin="0,4,0,0" VerticalAlignment="Center" HorizontalAlignment="Left" />
                    <TextBlock Grid.Row="1" Grid.Column="4" Margin="10,4,0,0" FontWeight="SemiBold" Text="{Binding GameType}" VerticalAlignment="Center" />

                    <!-- Row 2 -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Game Port:" Margin="0,4,0,0" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="2" Grid.Column="1" Margin="10,4,0,0" FontWeight="SemiBold" Text="{Binding GamePort, StringFormat={}{0:N0}}" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="2" Grid.Column="3" Text="Query Port:" Margin="0,4,0,0" VerticalAlignment="Center" HorizontalAlignment="Left" />
                    <TextBlock Grid.Row="2" Grid.Column="4" Margin="10,4,0,0" FontWeight="SemiBold" Text="{Binding QueryPort, StringFormat={}{0:N0}}" VerticalAlignment="Center" />

                    <!-- Row 3 -->
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Beacon Port:" Margin="0,4,0,0" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="3" Grid.Column="1" Margin="10,4,0,0" FontWeight="SemiBold" Text="{Binding BeaconPort, StringFormat={}{0:N0}}" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="3" Grid.Column="3" Text="RCON Port:" Margin="0,4,0,0" VerticalAlignment="Center" HorizontalAlignment="Left" />
                    <TextBlock Grid.Row="3" Grid.Column="4" Margin="10,4,0,0" FontWeight="SemiBold" Text="{Binding RconPort, StringFormat={}{0:N0}}" VerticalAlignment="Center" />

                    <!-- Row 4 -->
                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Local IP:" Margin="0,4,0,0" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="4" Grid.Column="1" Margin="10,4,0,0" FontWeight="SemiBold" Text="{Binding LocalIpText}" VerticalAlignment="Center" />

                    <!-- Row 5 -->
                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Uptime:" Margin="0,8,0,0" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="5" Grid.Column="1" Margin="10,8,0,0" FontWeight="SemiBold" Text="{Binding CurrentUptimeText}" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="5" Grid.Column="3" Text="Restarts:" Margin="0,8,0,0" VerticalAlignment="Center" HorizontalAlignment="Left" />
                    <TextBlock Grid.Row="5" Grid.Column="4" Margin="10,8,0,0" FontWeight="SemiBold" Text="{Binding RestartCount, StringFormat={}{0:N0}}" VerticalAlignment="Center" />

                    <!-- Row 6 -->
                    <TextBlock Grid.Row="6" Grid.Column="0" Text="Memory Usage:" Margin="0,8,0,0" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="6" Grid.Column="1" Margin="10,8,0,0" FontWeight="SemiBold"
                               Text="{Binding PrivateMemorySize64, Converter={x:Static converters:BytesToMiBConverter.Instance}, StringFormat={}{0:N1} MiB}" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="6" Grid.Column="3" Text="Handle Count:" Margin="0,8,0,0" VerticalAlignment="Center" HorizontalAlignment="Left" />
                    <TextBlock Grid.Row="6" Grid.Column="4" Margin="10,8,0,0" FontWeight="SemiBold" Text="{Binding HandleCount, StringFormat={}{0:N0}}" VerticalAlignment="Center" />

                    <!-- Row 7 -->
                    <TextBlock Grid.Row="7" Grid.Column="0" Text="Peak:" Margin="0,4,0,0" VerticalAlignment="Center" />
                    <TextBlock Grid.Row="7" Grid.Column="1" Margin="10,4,0,0" FontWeight="SemiBold"
                               Text="{Binding PeakPrivateMemorySize64, Converter={x:Static converters:BytesToMiBConverter.Instance}, StringFormat={}{0:N1} MiB}" VerticalAlignment="Center" />

                    <!-- Row 8 (bottom): Mods list -->
                    <TextBlock Grid.Row="8" Grid.Column="0" Text="Mods:" Margin="0,8,0,0" VerticalAlignment="Top" />
                    <TextBlock Grid.Row="8" Grid.Column="1" Grid.ColumnSpan="4" Margin="10,8,0,0" FontWeight="SemiBold"
                               Text="{Binding ModActorsText}" TextWrapping="Wrap" VerticalAlignment="Top" />
                </Grid>

                <!-- Graphs (right of active info) -->
                <StackPanel Grid.Column="2">
                    <StackPanel>
                        <TextBlock FontWeight="SemiBold" Text="Memory Usage" />
                        <Border Margin="0,4,0,0"
                                Height="64"
                                CornerRadius="4"
                                Background="{DynamicResource Brush.Background}"
                                BorderBrush="{DynamicResource Brush.Border}"
                                BorderThickness="1"
                                Padding="6">
                            <Grid ClipToBounds="True">
                                <Path Stroke="{DynamicResource Brush.Primary}"
                                      StrokeThickness="2"
                                      StrokeLineJoin="Round"
                                      StrokeStartLineCap="Round"
                                      StrokeEndLineCap="Round">
                                    <Path.Data>
                                        <MultiBinding Converter="{x:Static converters:LineChartGeometryConverter.Instance}"
                                                      ConverterParameter="2">
                                            <Binding Path="DisplayPrivateMemoryHistoryMiB" />
                                            <Binding Path="DisplayPrivateMemoryHistoryMaxMiB" />
                                            <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Border}" />
                                            <Binding Path="ActualHeight" RelativeSource="{RelativeSource AncestorType=Border}" />
                                            <!-- Force converter re-evaluation when the collection contents change -->
                                            <Binding Path="DisplayPrivateMemoryHistoryMiB.Count" />
                                        </MultiBinding>
                                    </Path.Data>
                                </Path>

                                <!-- Hover surface for tooltips -->
                                <Rectangle Fill="Transparent"
                                           behaviors:ChartHoverBehavior.IsEnabled="True"
                                           behaviors:ChartHoverBehavior.ValueKind="MemoryMiB"
                                           behaviors:ChartHoverBehavior.SampleStepSeconds="10"
                                           behaviors:ChartHoverBehavior.History="{Binding DisplayPrivateMemoryHistoryMiB}"
                                           ToolTip="{Binding RelativeSource={RelativeSource Self}, Path=(behaviors:ChartHoverBehavior.ToolTipText)}"
                                           ToolTipService.InitialShowDelay="0"
                                           ToolTipService.ShowDuration="60000" />
                            </Grid>
                        </Border>
                    </StackPanel>

                    <StackPanel Margin="0,12,0,0">
                        <TextBlock FontWeight="SemiBold" Text="Players" />
                        <Border Margin="0,4,0,0"
                                Height="64"
                                CornerRadius="4"
                                Background="{DynamicResource Brush.Background}"
                                BorderBrush="{DynamicResource Brush.Border}"
                                BorderThickness="1"
                                Padding="6">
                            <Grid ClipToBounds="True">
                                <Path Stroke="{DynamicResource Brush.Primary}"
                                      StrokeThickness="2"
                                      StrokeLineJoin="Round"
                                      StrokeStartLineCap="Round"
                                      StrokeEndLineCap="Round">
                                    <Path.Data>
                                        <MultiBinding Converter="{x:Static converters:LineChartGeometryConverter.Instance}"
                                                      ConverterParameter="2">
                                            <Binding Path="DisplayPlayerCountHistory" />
                                            <Binding Path="DisplayPlayerCountHistoryMax" />
                                            <Binding Path="ActualWidth" RelativeSource="{RelativeSource AncestorType=Border}" />
                                            <Binding Path="ActualHeight" RelativeSource="{RelativeSource AncestorType=Border}" />
                                            <!-- Force converter re-evaluation when the collection contents change -->
                                            <Binding Path="DisplayPlayerCountHistory.Count" />
                                        </MultiBinding>
                                    </Path.Data>
                                </Path>

                                <!-- Hover surface for tooltips -->
                                <Rectangle Fill="Transparent"
                                           behaviors:ChartHoverBehavior.IsEnabled="True"
                                           behaviors:ChartHoverBehavior.ValueKind="Players"
                                           behaviors:ChartHoverBehavior.SampleStepSeconds="10"
                                           behaviors:ChartHoverBehavior.History="{Binding DisplayPlayerCountHistory}"
                                           ToolTip="{Binding RelativeSource={RelativeSource Self}, Path=(behaviors:ChartHoverBehavior.ToolTipText)}"
                                           ToolTipService.InitialShowDelay="0"
                                           ToolTipService.ShowDuration="60000" />
                            </Grid>
                        </Border>
                    </StackPanel>
                </StackPanel>

            </Grid>

            <!-- Map controls (full-width bottom row) -->
            <Grid Grid.Row="3" Margin="0,12,0,0" HorizontalAlignment="Stretch">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <ComboBox Grid.Column="0"
                          ItemsSource="{Binding AvailableMaps}"
                          SelectedItem="{Binding SelectedMapToChange}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Center">
                    <!-- Preserve '_' in map names (avoid AccessText underscore handling for raw string items) -->
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding MapName}" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                <Button Grid.Column="1"
                        Content="Change Map"
                        Margin="10,0,0,0"
                        Command="{Binding ChangeMapCommand}"
                        IsEnabled="{Binding CanChangeMap}"
                        Style="{StaticResource Button.Primary}" />

                <Button Grid.Column="2"
                        Content="Start Next Map"
                        Margin="10,0,0,0"
                        Command="{Binding StartNextMapCommand}"
                        Style="{StaticResource Button.Secondary}" />
            </Grid>
        </Grid>
    </Border>
</UserControl>